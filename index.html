<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="utf-8">
  <title>실시간 고속도로 통행량 히트맵</title>
  <style>
    body,
    html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      font-family: sans-serif;
    }

    #map {
      width: 100%;
      height: 100vh;
      position: relative;
    }

    .ui-panel {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 100;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    #loading-status {
      color: #e67e22;
      font-weight: bold;
    }

    .legend {
      margin-top: 10px;
      font-size: 12px;
    }

    .legend span {
      display: inline-block;
      width: 30px;
      height: 10px;
      margin-right: 5px;
    }
  </style>
</head>

<body>

  <div class="ui-panel">
    <h3 style="margin:0 0 10px 0;">전국 고속도로 통행량</h3>
    <div id="loading-status">데이터 로딩 중...</div>
    <div class="legend">
      <div><span style="background:red"></span> 혼잡 (5000대↑)</div>
      <div><span style="background:yellow"></span> 보통</div>
      <div><span style="background:blue"></span> 원활</div>
    </div>
  </div>

  <div id="map"></div>

  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=a3a42c7f67bafba966c8452bc00755cf"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/heatmap.js/2.0.2/heatmap.min.js"></script>

  <script>
    // 설정값
    // const EX_KEY = '2407937665'; // 한국도로공사 인증키 (Decoding 키 추천)
    let trafficPoints = [];

    // 지도 초기화
    const mapContainer = document.getElementById('map');
    const mapOption = {
      center: new kakao.maps.LatLng(36.5, 127.5),
      level: 11
    };
    const map = new kakao.maps.Map(mapContainer, mapOption);

    // 히트맵 설정
    const heatmap = h337.create({
      container: mapContainer,
      radius: 40,
      maxOpacity: .6,
      blur: .85,
      gradient: { '.2': 'blue', '.5': 'lime', '.8': 'yellow', '.95': 'red' }
    });

    // 주요 영업소 좌표 데이터 (API 데이터와 매칭용)
    const cityCoords = {
      "서울": { lat: 37.362, lng: 127.108 }, "수원": { lat: 37.263, lng: 127.028 },
      "대전": { lat: 36.350, lng: 127.384 }, "대구": { lat: 35.871, lng: 128.601 },
      "부산": { lat: 35.179, lng: 129.075 }, "광주": { lat: 35.160, lng: 126.851 },
      "강릉": { lat: 37.751, lng: 128.876 }, "인천": { lat: 37.456, lng: 126.705 },
      "울산": { lat: 35.539, lng: 129.311 }, "춘천": { lat: 37.885, lng: 127.730 }
    };

    // 데이터 호출 함수 (AllOrigins 프록시 사용)
    async function getTrafficData() {
      const statusTag = document.getElementById('loading-status');

      // [중요] 키가 %를 포함하고 있다면 Decoding 키를 넣는 것이 가장 안전합니다.
      const EX_KEY = '2407937665';

      // 호출할 원본 URL (http/https 혼용 에러 방지를 위해 http로 작성)
      const targetUrl = `http://data.ex.co.kr/openapi/od_data/view?key=${EX_KEY}&type=json&listType=key`;

      // AllOrigins 프록시 사용 (cache-busting을 위해 시간값 추가)
      const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}&_=${Date.now()}`;

      try {
        const response = await fetch(proxyUrl);
        if (!response.ok) throw new Error('Proxy Server Response Error');

        const result = await response.json();

        // 데이터가 문자열로 올 경우를 대비한 2중 파싱
        let data = result.contents;
        if (typeof data === 'string') {
          data = JSON.parse(data);
        }

        // 도로공사 API 특유의 에러 메시지 처리 (키가 틀린 경우)
        if (data.code === 'ERROR' || data.message === '인증되지 않은 키입니다.') {
          throw new Error('API_KEY_INVALID');
        }

        if (data.list && data.list.length > 0) {
          processTraffic(data.list);
          statusTag.innerText = "실시간 데이터 업데이트 완료";
          statusTag.style.color = "#27ae60";
        } else {
          statusTag.innerText = "데이터가 없습니다 (검색 결과 없음)";
        }
      } catch (error) {
        console.error('상세 에러 내역:', error);

        if (error.message === 'API_KEY_INVALID') {
          statusTag.innerText = "호출 실패: API 키가 올바르지 않음";
        } else {
          statusTag.innerText = "호출 실패: 네트워크 또는 프록시 에러";
        }
        statusTag.style.color = "#c0392b";
      }
    }

    function processTraffic(apiList) {
      trafficPoints = apiList.map(item => {
        const coord = cityCoords[item.unitName];
        if (coord) {
          return {
            lat: coord.lat,
            lng: coord.lng,
            count: parseInt(item.trafficAmout) || 0
          };
        }
        return null;
      }).filter(p => p !== null);

      updateHeatmap();
    }

    function updateHeatmap() {
      const points = [];
      const projection = map.getProjection();

      trafficPoints.forEach(p => {
        const pixel = projection.pointFromCoords(new kakao.maps.LatLng(p.lat, p.lng));
        points.push({ x: pixel.x, y: pixel.y, value: p.count });
      });

      // max값을 5000 정도로 설정하면 색상 변화가 뚜렷합니다.
      heatmap.setData({ max: 5000, data: points });
    }

    // 지도 이벤트: 움직임이 멈췄을 때 히트맵 재계산
    kakao.maps.event.addListener(map, 'idle', updateHeatmap);

    // 실행
    getTrafficData();
  </script>
</body>

</html>
