<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>실시간 고속도로 통행량 히트맵</title>
    <style>
        #map { width: 100%; height: 800px; background-color: #f0f0f0; }
        .loading { position: fixed; top: 10px; left: 10px; z-index: 10; background: white; padding: 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    </style>
</head>
<body>
    <div id="loading" class="loading">데이터 로딩 중...</div>
    <div id="map"></div>

    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=a3a42c7f67bafba966c8452bc00755cf"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/heatmap.js/2.0.2/heatmap.min.js"></script>

    <script>
        const EX_KEY = '2407937665'; // 도로공사 API 키
        let trafficPoints = []; // API에서 받아온 데이터를 저장할 배열

        // 1. 지도 초기화
        const mapContainer = document.getElementById('map');
        const mapOption = { center: new kakao.maps.LatLng(36.5, 127.5), level: 11 };
        const map = new kakao.maps.Map(mapContainer, mapOption);

        // 2. 히트맵 인스턴스 초기화
        const heatmap = h337.create({
            container: mapContainer,
            radius: 35,
            maxOpacity: .6,
            blur: .85,
            gradient: { '.2': 'blue', '.5': 'lime', '.8': 'orange', '.95': 'red' }
        });

        // 3. 도로공사 실시간 데이터 호출 함수
        async function fetchTrafficData() {
            // CORS 우회를 위한 공용 프록시 (실제 서비스시는 개인 서버 권장)
            const proxy = "https://cors-anywhere.herokuapp.com/";
            const targetUrl = `http://data.ex.co.kr/openapi/od_data/view?key=${EX_KEY}&type=json&listType=key`;

            try {
                const response = await fetch(proxy + targetUrl);
                const data = await response.json();
                
                // 도로공사 '실시간 전국 교통량' 데이터는 보통 'list' 배열에 담겨 옵니다.
                // 주의: 해당 API는 위치(좌표)를 주지 않으므로, 주요 거점 좌표와 매칭이 필요합니다.
                if (data.list) {
                    processData(data.list);
                }
            } catch (error) {
                console.error("API 호출 에러:", error);
                document.getElementById('loading').innerText = "데이터 호출 실패 (CORS 또는 키 확인)";
            }
        }

        // 4. 데이터 가공 (영업소/지점별 좌표 매칭)
        function processData(apiList) {
            // 실제 서비스에서는 모든 VDS 좌표 DB가 필요하지만, 
            // 여기서는 시연을 위해 주요 영업소 좌표와 API의 데이터를 매칭하는 예시입니다.
            const cityCoords = {
                "서울": {lat: 37.362, lng: 127.108},
                "수원": {lat: 37.263, lng: 127.028},
                "대전": {lat: 36.350, lng: 127.384},
                "대구": {lat: 35.871, lng: 128.601},
                "부산": {lat: 35.179, lng: 129.075},
                "광주": {lat: 35.160, lng: 126.851},
                "강릉": {lat: 37.751, lng: 128.876}
            };

            trafficPoints = apiList.map(item => {
                // API의 'unitName'(영업소명)과 위 좌표 객체를 매칭
                const coord = cityCoords[item.unitName]; 
                if (coord) {
                    return {
                        lat: coord.lat,
                        lng: coord.lng,
                        count: parseInt(item.trafficAmout) || 100 // 교통량 수치
                    };
                }
                return null;
            }).filter(p => p !== null);

            updateHeatmap();
            document.getElementById('loading').style.display = 'none';
        }

        // 5. 히트맵 갱신 함수
        function updateHeatmap() {
            const points = [];
            const projection = map.getProjection();

            trafficPoints.forEach(p => {
                const pixel = projection.pointFromCoords(new kakao.maps.LatLng(p.lat, p.lng));
                points.push({ x: pixel.x, y: pixel.y, value: p.count });
            });

            // max값은 데이터 중 가장 높은 교통량 수치에 맞춰 조절하면 가독성이 좋아집니다.
            heatmap.setData({ max: 5000, data: points });
        }

        // 지도 이동/확대 시 히트맵 위치 재계산
        kakao.maps.event.addListener(map, 'idle', updateHeatmap);

        fetchTrafficData();
    </script>
</body>
</html>